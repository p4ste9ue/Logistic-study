<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>采购计划单</title>
</head>
<link rel="stylesheet" type="text/css" href="/easyUI/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="/easyUI/themes/icon.css">
<link rel="stylesheet" type="text/css" href="/easyUI/themes/myicon.css">
<link rel="stylesheet" type="text/css" href="/easyUI/themes/color.css">
<link rel="stylesheet" type="text/css" href="/myCSS/demo.css">

<script type="text/javascript" src="/easyUI/jquery.js"></script>
<script type="text/javascript" src="/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/easyUI/locale/easyui-lang-zh_CN.js"></script>

<script type="text/javascript" src="/easyUI/extJquery.js"></script>
<script type="text/javascript" src="/easyUI/extEasyUI.js"></script>
<script type="text/javascript" src="/myJs/showMessage.js"></script>
<script type="text/javascript">
	let url=location.search;
	let Request = new Object();
	let id ;	// 订单ID
	if (url.indexOf("?") != -1) {
		var str = url.substr(1)　//去掉?号
		strs = str.split("&");
		for (var i = 0; i < strs.length; i++) {
			Request[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
		}
		id = Request["id"];
	}

	let editrow = 'undefined';
	let dataGrid;

	$(function() {
		// 注册dataGrid
		dataGrid = $('#dg_purchaseDetail')
				.datagrid({
					url : httphost + '/purchasePlan/getPurchasePlanDetails/' + id,
					pagination : true,
					fitColumns : true,
					fit : true,
					rownumbers : true,
					singleSelect : true,
					border : false,
					striped : true,
					idField : 'id',
					pageSize : 20,
					pageList : [10,20,50,100,200 ],
					frozenColumns : [ [ {
						field : 'id',
						title : 'ID',
						align : 'center',
						hidden: true,
						width : 80,
					}, {
						field : 'goodsPid',
						title : '商品名称',
						width : 140,
						align: "center",
						formatter: function(value, row, index) {
							return row.goodsName;
						},
						editor : {type : 'combogrid',options : {required : false,
								panelWidth:380,
								panelHeight:450,
								idField : 'id',
								textField : 'sname',
								pagination : true,
								fitColumns : true,
								fit : true,
								rownumbers : true,// 显示行号
								singleSelect : true,// 只能单选
								border : false,
								striped : true,// 隔行变色
								url: httphost + '/goods/getGoods',
								pageList : [15,30,50],
								keyHandler:{
									query: function (q) {
										$('#comboGrid-editor').combogrid('grid').datagrid('load', {sname: q});
										$('#comboGrid-editor').combogrid('setValue',q);
									}
								} ,
								columns:[[
									{field:'id',title:'ID'},
									{field:'sno',title:'商品编号',width : 60},
									{field:'sname',title:'商品名称',align:'center'},
									{field:'goodType',title:'商品类别',width : 160},
								]],
								onSelect: function(row, rowData){
									//rowData.hmNo=rowData.hmNo+rowData.tpcNo;
									//rowData.tpcNo=rowData.hmNo+rowData.tpcNo;
									var rowIndex= dataGrid.datagrid('getRowIndex',dataGrid.datagrid('getSelected'));
									dataGrid.datagrid('beginEdit', rowIndex);
									let editors = dataGrid.datagrid('getEditors', rowIndex);
									console.info(editors);
									let goodType = dataGrid.datagrid('getEditor', { index: rowIndex, field: 'goodsTypeName' });
									//console.info(rowData.goodType);
									/*	ed.target.textbox('setValue',rowData.USERNAME);//textbox赋值方法
                                        $(ed.target).val(rowData.USERNAME);//text赋值方法*/
									$(goodType.target).val(rowData.goodType);
								}
							} },
						onChange:function (rowIndex, rowData, changes){
							console.info(rowData);
						}
					}, {
						field : 'goodsTypeName',
						title : '商品类别',
						width : 140,
						align: "center",
						sortable : true,
						editor: {
							type: 'text',
						}
					}
					] ],
					columns : [ [
						{
							field : 'num',
							title : '计划采购数量',
							width : 110,
							align: "center",
							sortable : true,
							editor : {
								type : 'validatebox',
								options : {
									required : false,
								}
							}
						},{
							field : 'price',
							title : '采购价格',
							align : 'center',
							width : 160,
							editor : {
								type : 'validatebox',
								options : {
									required : false,
								}
							}
						} ,
						{
							field : 'alreadyNum',
							title : '已采购数量',
							align : 'center',
							width : 160,
						} ,
						{
							field : 'actor',
							title : '操作',
							width : 170,
							formatter : function(value, row, index) {
								var str = '';
								str += $
										.formatString(
												'<img onclick="editFun(\'{0}\');" src="{1}" title="编辑"/>',
												index,
												'../../easyUI/themes/extjs_icons/pencil.png');

								str += '&nbsp;&nbsp;';
								str += $.formatString('<img onclick="deleteFun(\'{0}\');" src="{1}" title="删除"/>', index, '../../easyUI/themes/extjs_icons/cancel.png');

								return str;
							}
						}
					] ],
					toolbar : '#toolbar',

					onLoadSuccess : function() {
						parent.$.messager.progress('close');

						$(this).datagrid('tooltip');
					},
					onEndEdit : function (index, row, changes){

					}
				});
		afterSuccessLoad();
	});

	/**
	 * 页面加载完毕后，马上运行此函数，根据是否为新增，进入编辑和新增功能
	 * szy
	 * 2023-3-30
	 */
	function afterSuccessLoad(){
		if(id > 0){		// 订单的修改页面
			//获取单头信息
			$.ajax({
				type: "POST",
				url: httphost + "/purchasePlan/getSinglePurchasePlan",
				data: {'id':id},
				success: function (result) {
					//console.info(result.sno);
					$('#sno').val(result.sno);
					$('#warehouse').val(result.warehouse);
					$('#createBy').val(result.createBy);
					$('#dueDate').val(result.dueDate);
					$('#w').window({title:"采购计划单： -- &nbsp;&nbsp; 修改"}) ;
				}
			});

		}else{	// 新增界面
			$('#w').window({title:"采购计划单： -- &nbsp;&nbsp; 新增"}) ;
		}
	}


	function editFun(index) {
		if (editrow != 'undefined') {
			dataGrid.datagrid('endEdit', editrow);
		}
		dataGrid.datagrid('removeEditor', [ 'id' ]);
		//let editRow = dataGrid.datagrid('getData').rows[index];
		// console.info(editRow);

		dataGrid.datagrid('beginEdit', index);
		editrow = index;
	}

	function deleteFun(id) {
		//console.info(id);
		if (id != undefined) {
			dataGrid.datagrid('selectRow', id);
		}
		var rows = dataGrid.datagrid('getSelections');
		//console.info(rows);
		if (rows.length > 0) {
			parent.$.messager.confirm('询问', '您是否要删除当前称？', function(b) {
				if (b) {
					parent.$.messager.progress({
						title : '提示',
						text : '数据处理中，请稍后....'
					});
					dataGrid.datagrid('deleteRow',id);
					parent.$.messager.progress('close');
				}
			});
		}
	}

	function afterEdit(rowIndex, rowData, changes) {
		var inserted = dataGrid.datagrid('getChanges', 'inserted');
		var updated = dataGrid.datagrid('getChanges', 'updated');
		var url = "";
		var data = {};

	}


</script>
<body>

<!--<div style="margin:20px 0;">
	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="$('#w').window('open')">Open</a>
	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="$('#w').window('close')">Close</a>
</div>-->
<div id="w" class="easyui-window" title="采购计划单 " data-options="iconCls:'icon-save'" style="width:800px;height:700px;padding:5px;">
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'north',split:true" style="height:100px" >
			<form id="fm_purchasePlan">
				<table style="padding:10px 0 0 0;">
					<tr><td>采购计划单号：</td><td><input id="sno" name="sno" ></td><td>仓库：</td><td><input id="warehouse" name="warehouse" ></td>
						<td>制单人</td><td><input id="createBy" name="createBy" ></td>
					</tr>
					<tr><td>要求终完成日期：</td><td><input id="dueDate" name="dueDate" ></td>
					</tr>
				</table>
				<div style="text-align:right;padding:2px 0 2px;">
					<a class="easyui-linkbutton" data-options="iconCls:'icon-add'" href="javascript:void(0)" onclick="javascript:alert('ok')" style="width:90px">新增一行</a>
				</div>
			</form>
		</div>
		<div data-options="region:'center'" style="padding:0 0 40px 0;">
			<div id="dg_purchaseDetail"/>
		</div>
		<div data-options="region:'south'" style="text-align:right;padding:5px 0 0;">
			<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="javascript:alert('ok')" style="width:80px">Ok</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="javascript:alert('cancel')" style="width:80px">Cancel</a>
		</div>
	</div>
</div>

</body>
</html>